<!DOCTYPE html>
<html>
  <head>
    <!-- java script required for interacting with the RESTful API -->
    <script type="text/javascript" src="/site_media/jquery/js/jquery-1.6.1.min.js"></script>

    <!-- page style -->
    <style type='text/css'>
    #formwrap {
        line-height: 2em;
        background: #eef;
        margin: 10px;
        padding: 10px;
        height: 170px;
        text-align: center;
    }
    body {
        font-family: "Lucida Grande", "Lucida Sans Unicode", Verdana, Arial, Helvetica, sans-serif;
        font-size: 14px;
    }
    </style>

    <script type='text/javascript'>
        default_key = "";
        pluginGET = "";

	$(document).ready(function(){

		var a1 = $.ajax({
			url:"/rundb/api/v1/plugin/DataExport/extend/backupDevices/?format=json",
			dataType:"json",
			type: "GET",
			async: true,

			});

		a1.done(function() {
			pluginGET = TB_plugin.fields;
			console.log(TB_plugin.fields);
			$.each(pluginGET.config, function(key, val){
				if (key == "DB_LOCATION"){
					document.getElementById("DB_LOCATION").value = val;
					$("#database_loaction").val(val);
				}
				if (key == "STRAIN_BACKUP"){
					document.getElementById("STRAIN_BACKUP").value = val;
					$("#backup_location").val(val);
				}
			});
		});
    });


        //turn the html objects into json objects
        $(function() {
            $.fn.serializeObject = function(){
                var o = {};
                var a = this.serializeArray();
                a = a.concat(
                  jQuery('#globalconfig input[type=checkbox]:not(:checked)').map(
                          function() {
                              return {"name": this.name, "value": "off"}
                          }).get());

                console.log(a)
                $.each(a, function() {
                    console.log(this.name+" : "+this.value);
                    if (o[this.name] != null) {
                        if (!o[this.name].push) {
                            o[this.name] = [o[this.name]];

                        }
                        o[this.name].push(this.value || '');
                    } else {
                        o[this.name] = this.value || '';
                    }
                });
                console.log(o);
                return o;
            };
        });

        //use the RESTful API to post the json objects to the plugin
        $(function() {
            $('#postbutton').click(function() {

				// this form name "pluginconfig" should match the one used in the html page
                obj =  $('#globalconfig').serializeObject();
                //use the data retreived from the GET and modify it only the config key is changed
                pluginGET.config = obj;
                pluginAPIJSON = JSON.stringify(pluginGET);
                console.log(TB_plugin.pk);
                console.log(pluginAPIJSON);
                pluginURL = "/rundb/api/v1/plugin/" + TB_plugin.pk + "/?format=json";
                $.ajax({
                    type: 'PUT',
                    url: pluginURL,
                    contentType: "application/json; charset=utf-8",
                    success: function () {parent.$.fn.colorbox.close();},
                    data: pluginAPIJSON,
                    dataType: "json"
                });
            });
        });
    </script>
</head>

  <!-- set up the html page that the user interacts with -->
<body>
        <!-- this form id, in this case "pluginconfig", should match the one called in PUT java script -->
        <form id="globalconfig" align="center">
            <div class="page-header">
              <h1 align="center">StrainConstructMer - Global Settings</h1></center>
            </div>
			<div id="formwrap">
            <table align="center">
            <tr>
              <td align=right>Strain Database Location: </td><td align=left>
				<input type="text" id="DB_LOCATION" name="DB_LOCATION" value="/results/plugins/scratch/"/>
			  </td>
            </tr>


            <tr>
              <td align=right>Backup directory: </td><td align=left>
				<input type="text" id="STRAIN_BACKUP" name="STRAIN_BACKUP" value="None"/>
			  </td>
            </tr>
            </table>

        </div>
		</form><p>
		<input id="postbutton" type="submit" value="Save Configuration">
</body>
</html>