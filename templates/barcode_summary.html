<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE HTML>
<html>

<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" media="all" href="/site_media/resources/bootstrap/css/bootstrap.min.css"/>
    <link href="/site_media/resources/kendo/styles/kendo.common.min.css" rel="stylesheet"/>
    <link href="/site_media/resources/less/kendo.tb.min.css" rel="stylesheet"/>
    <link type="text/css" rel="stylesheet" href="/site_media/resources/styles/tb-layout.css"/>
    <link type="text/css" rel="stylesheet" href="/site_media/resources/styles/tb-styles.min.css"/>

    <link rel="stylesheet" type="text/css" href="/site_media/stylesheet.css"/>
    <link rel="stylesheet" type="text/css" href="/site_media/resources/styles/print.css" media="print"/>
    <link rel="stylesheet" type="text/css" href="/site_media/resources/styles/report.css" media="screen"/>

    <script type="text/javascript" src="/site_media/resources/jquery/jquery-1.8.2.min.js"></script>
    <script type="text/javascript" src="/site_media/resources/bootstrap/js/bootstrap.min.63efdaa68dbd.js"></script>
    <script type="text/javascript" src="/site_media/resources/scripts/kendo.custom.min.js"></script>

    <script type="text/javascript"
            src="/site_media/resources/bootstrap-modal/js/bootstrap-modalmanager.50bbb3f30017.js"></script>
    <script type="text/javascript"
            src="/site_media/resources/bootstrap-modal/js/bootstrap-modal.6b96b139b977.js"></script>

    {% load humanize %}

    <style type="text/css">
        body {
            background: white
        }

        .flag_size{
            width:40px;
            height:40px;
        }

        .help {
            cursor: help;
            border-bottom: 1px dotted #A9A9A9
        }

        td {
            word-break: break-all
        }


        a[href]:after { content: ""; }

        a:link:after, a:visited:after {
            content: "";
            }

        .k-grid-header .k-header .k-link {
            text-align: center;
            font-size: inherit;
            font: inherit;
        }

        .k-grid tr td {
            {#font-size: 100%;#}
            font-size: 1.2vw;
            font-weight: normal;
            border-bottom: 1px solid black;
            border-left: 1px dashed lightgrey;
            padding: 0;
            text-align: center;
            line-height: 100%;
            height:100%;}

        .link a tr {
            font-size: 100px;
            font-weight: bold;

        }
        .k-header {
            text-align: center;
            font-size: larger;
        }

        .mylead {
            font-size: 3rem;
            font-weight: 500;
        }

        .preformat {
            white-space: pre
        }

        .k-link{
            font: inherit !important;
            font-size: 1.0vw !important;
        }
    </style>
</head>

<title>Strain Analysis Report</title>
<body>

<div class="container-fluid">


    <img src="/pluginMedia/{{plugin_name}}/images/ARUP_horz_2c_pos.jpg" style="padding-top:20px;width: 25%; height: auto"/>


    <p class="mylead" >Strain Analysis Report</p>
    <h4 class="display-4">plugin run date: {{ date_run }}</h4>


    <script type="text/javascript">
        function numberWithCommas(x) {
            if (x == null || isNaN(x)) return "NA";
            var parts = x.toString().split(".");
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            return parts.join(".");
        }

        function numberToPercent(x) {
            if (isNaN(x)) return x;
            return (100 * x) + "%";
        }

        function modal_popup(name, url) {
            console.log(name + " " + url);
            $("#modal_barcode_len_name").text(name);
            $("#modal_barcode_len_images").html('<img src="' + url + '"/>');
            $("#modal_barcode_len").modal('show');
        }

        var barcodes_json = {{plugin_results|safe}};

        $(document).ready(function () {
            if (typeof barcodes_json !== 'undefined') {
                $("#barcodes").kendoGrid({
                    height: 'auto',
                    groupable: false,
                    scrollable: false,
                    selectable: false,
                    sortable: {mode: "single", allowUnsort: true},
                    pageable: {pageSizes: [5, 10, 20, 50, 100]},
                    dataSource: {
                        data: barcodes_json,
                        schema: {
                            model: {
                                fields: {
                                    passed_qc: {type: "string"},
                                    barcode: {type: "string"},
                                    //{#accession: {type: "string"},#}
                                    strain_id: {type: "string"},
                                    instance: {type: "string"},
                                    coverage: {type: "number"},
                                    genome_size: {type: "number"},
                                    within_expected_genome_size: {type: "string"},
                                    pct_q20_bases: {type: "number"},
                                    //{#count_intersection: {type: "number"},#}
                                    top_hit: {type: "string"},
                                    // {#mlst_profile: {type: "string"},#}
                                    mongo: {type: "string"},
                                    backup: {type: "string"},
                                    histo_image: {type: "string"}
                                }
                            }
                        },
                        pageSize: 10
                    },
                    columns: [
                        {field: "passed_qc", width: 50, color: "rgb(0,62,117)"},
                        {field: "barcode", width: 80, color: "rgb(0,62,117)"},
                        //{#{field: "accession", width: 120},#}
                        {field: "strain_id", width: 120},
                        {field: "instance", width: 50},
                        {
                            field: "coverage", headerAttributes: {
                                style: "text-align: center"
                            },
                            width: 60
                        },
                        {field: "genome_size", width: 80},
                        {field: "within_expected_genome_size", width: 60},
                        {field: "pct_q20_bases", width: 60},
                        //{#{field: "count_intersection", width: 80},#}
                        {field: "top_hit", width: 200},
                        //{#{field: "mlst_profile", width: 200},#}
                        {field: "mongo", width: 60},
                        {field: "backup", width: 60},

                        {
                            field: "histo_image",
                            title: "histo_image",
                            width: 240
                        }
                    ],
                    rowTemplate: kendo.template($("#barcodesRowTemplate").html())
                });
            }
        });

    </script>

    <div>
        <table id="barcodes" style="margin:0;width:100%" class="k-grid">
            <thead>
            <tr class="k-grid">
                <th title="{{ help_dict.barcode_name }}">Status</th>
                <th title="{{ help_dict.barcode_name }}">Barcode</th>
                <th class=k-header title="{{ help_dict.sample_id }}">Sample</th>
                <th class=k-header title="{{ help_dict.sample_id }}">Ver</th>
                <th class=k-header title="{{ help_dict.mapped_reads }}">Coverage</th>
                <th class=k-header title="{{ help_dict.mapped_reads }}">Genome Size (bp)</th>
                <th class=k-header title="{{ help_dict.mapped_reads }}">Within Expected Range</th>
                <th class=k-header title="{{ help_dict.mapped_reads }}">Q20 Bases</th>
                <th title="{{ help_dict.uniformity }}">Top Classifier Hit</th>
                <th title="{{ help_dict.uniformity }}">Sample Saved</th>
                <th title="{{ help_dict.uniformity }}">Resistant Genes</th>
                <th title="histo">Kmer Histogram</th>

            </tr>
            </thead>
            <script id="barcodesRowTemplate" type="text/x-kendo-tmpl">
      <tr>
        <td> <a href= #= report_directory # target="_blank"> <img class="flag_size" src= #= qc_icon # /> </a> </td>
        <td class="lead"> #= barcode # </td>
        <td class="lead" align="left" > #= (strain_id) ? strain_id : "None" #</td>
        <td class="lead" align="left" > #= (strain_instance) ? strain_instance : "-" #</td>
        <td class="lead" align="left"> <font style="color: #= coverage_format # ;">#=numberWithCommas(coverage)#</font>&thinsp;X</td>
        <td class="lead" align="left" style="color: #= genome_size_format # ;"> #= numberWithCommas(genome_size) # </td>
        <td class="lead" title= "#= genome_size_help #" > <img   src= #= genome_size_icon # class="flag_size" /> </td>
        <td class="lead" align="left" style="color: #= qc_base_format # ;" > #=pct_q20_bases#%</td>
        <td class="lead link" align="left" >
                <a class=link href= #= classifier_html # target="_blank" style="font-size:1.3vw"> <i>#= top_hit_species #</i> (#= top_hit_kid #%) </a>

        </td>
        <td title= "#= mongo_help #" > <img   src= #= mongo_icon # class="flag_size" /> </td>
        <td  > <a href= #= resistant_html # target="_blank"> <img   src= #= drug_icon #  /> </td>
        <td> <img  onclick="modal_popup('#= (barcode) #', '#= histo_image #' )"  src= #= histo_image # /></td>
      </tr>
            </script>
        </table>
    </div>

    <div id="modal_barcode_len" class="modal hide">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h3 id="modal_barcode_len_name">Histogram</h3>
        </div>
        <div class="modal-body">
            <p id="modal_barcode_len_images"></p>
        </div>
        <div class="modal-footer">
            <a href="#" data-dismiss="modal" class="btn">Close</a>
        </div>
    </div>
</div>
</body>
</html>

